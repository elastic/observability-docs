[[custom-threshold-alert]]
= Create a custom threshold rule

preview::[]

Create a custom threshold rule to trigger alerts when an {observability} data type reaches or exceeds a given value.

. To access this page, go to **{observability}** -> **Alerts**.
. Click **Manage Rules** -> **Create rule**.
. Under **Select rule type**, select **Custom threshold**.

[role="screenshot"]
image::images/custom-threshold-rule.png[Custom threshold alert configuration,75%]

[discrete]
[[custom-threshold-scope]]
= Define the rule scope

Specify the following settings to define the data you want to apply your rule to:

* *Select a data view:* Select a data view that points to the indices or data streams that you're creating a rule for. Create a new data view by clicking *Create a data view*. Refer to {kibana-ref}/data-views.html[Create a data view] for more on creating data views.
* *Define query filter (optional):* Use a query filter to narrow down the data that your rule applies to. For example, set a query filter to a specific host name--`host.name:host-1`-- for the rule to only apply to that host.

[discrete]
[[custom-threshold-rule-conditions]]
= Set rule conditions

Set the conditions that for the rule to detect.

[discrete]
[[custom-threshold-aggregation]]
== Aggregation

Aggregations summarize your data to make it easier to analyze.
Set any of the following aggregation types to gather data to create your rule.

* *Average:* The average value of a numeric field.
* *Max:* The highest value of a numeric field.
* *Min:* The lowest value of a numeric field.
* *Cardinality:* The approximate number of unique values in a field.
* *Document count:* The total number of documents in a field.
* *Sum:* The total of a numeric field in your dataset.

For example, if you want to gather the total number of log documents with a log level of `warn` or `error`, set the *Aggregation* to *Document count*, and set the *KQL Filter* to `log.level: ("warn" or "error")`. You can then set trigger alerts when the total number reaches a specific threshold. The following section contains more information on setting equations and thresholds.

[discrete]
[[custom-threshold-equation]]
== Equation and threshold

Set an equation using basic math or boolean logic for your aggregations.

Then, set a threshold using the following comparators:

* *Is above:* greater than the threshold
* *Is above or equals:* greater than or equal to the threshold
* *Is below:* less than the threshold
* *Is below or equals:* less than or equal to the threshold
* *Is between:* within the range of two threshold numbers
* *Is not between:* outside of the range of two threshold numbers

[discrete]
[[custom-threshold-chart-preview]]
== Preview chart

The preview chart provides a visualization of your configuration and how many entries match your configuration.
The shaded area shows the threshold you've set.

image::images/custom-threshold-preview-chart.png[Custom threshold preview chart,75%]

[discrete]
[[custom-threshold-group-by]]
== Group alerts by (optional)

Set one or more *group alerts by* fields for custom threshold rules to perform a composite aggregation against the selected fields.
When any of these groups match the selected rule conditions, an alert is triggered _per group_.

When you select multiple groupings, the group name is separated by commas.

For example, if you group alerts by the `host.name` and `host.architecture` fields, and there are two hosts (`Host A` and `Host B`) and two architectures (`Architecture A` and `Architecture B`), the composite aggregation forms multiple groups.

If the `Host A, Architecture A` group matches the rule conditions, but the `Host B, Architecture B` group doesn't, one alert is triggered for `Host A, Architecture A`.

If you select one field--for example, `host.name`--and `Host A` matches the conditions but `Host B` doesn't, one alert is triggered for `Host A`.
If both groups matches the conditions, alerts are triggered for both groups.

[IMPORTANT]
=====
When *group alerts by* fields are selected, but no documents contain the selected field(s) within the given time range of when the alert is triggered, you can't determine the group(s). This is relevant when the rule condition is sensitive to a certain number of documents, and that number might be `0`.

For example, when querying if a host has less than five documents matching a condition, an alert is not triggered
due to the host not reporting logs for the duration of the query.
=====

[discrete]
[[custom threshold-action-types]]
== Action types

Extend your rules by connecting them to actions that use the following supported built-in integrations.

[role="screenshot"]
image::images/alert-action-types.png[Alert action types]

After you select a connector, you must set the action frequency. You can choose to create a summary of alerts on each check interval or on a custom interval. Alternatively, you can set the action frequency such that you choose how often the action runs (for example, at each check interval, only when the alert status changes, or at a custom action interval). In this case, you must also select the specific threshold condition that affects when actions run: `Fired` or `Recovered`.

[role="screenshot"]
image::images/log-threshold-run-when-selection.png[Configure when a rule is triggered]

You can also further refine the conditions under which actions run by specifying that actions only run when they match a KQL query or when an alert occurs within a specific time frame:

- *If alert matches query*: Enter a KQL query that defines field-value pairs or query conditions that must be met for notifications to send. The query only searches alert documents in the indices specified for the rule.
- *If alert is generated during timeframe*: Set timeframe details. Notifications are only sent if alerts are generated within the timeframe you define.

[role="screenshot"]
image::images/logs-threshold-conditional-alert.png[Configure a conditional alert]

[discrete]
[[custom-threshold-action-variables]]
=== Action variables

Use the default notification message or customize it.
You can add more context to the message by clicking the icon above the message text box
and selecting from a list of available variables.

[role="screenshot"]
image::images/logs-threshold-alert-default-message.png[Default notification message for logs threshold rules with open "Add variable" popup listing available action variables,width=600]