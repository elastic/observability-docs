[[apm-beats-api-keys]]
= Grant access using API keys

Instead of using usernames and passwords, you can use API keys to grant
access to {es} resources. You can set API keys to expire at a certain time,
and you can explicitly invalidate them. Any user with the `manage_api_key`
or `manage_own_api_key` cluster privilege can create API keys.

APM Server instances typically send both collected data and monitoring
information to {es}. If you are sending both to the same cluster, you can use the same
API key. For different clusters, you need to use an API key per cluster.

NOTE: For security reasons, we recommend using a unique API key per APM Server instance.
You can create as many API keys per user as necessary.

[float]
[[apm-beats-api-key-publish]]
== Create an API key for writing events

To create an API key:

. Go to **Stack Management** in the main menu and find **API Keys** or use the {kibana-ref}/introduction.html#kibana-navigation-search[global search field].
. Click **Create API key**.
+
[role="screenshot"]
image::images/server-api-key-create.png[API key creation]
+
. Enter a name for your API key and select **Restrict privileges**.
In the role descriptors box, assign the appropriate privileges to the new API key. For example:
+
[source,json,subs="attributes,callouts"]
----
{
    "apm_writer": {
        "cluster": ["monitor"],
        "index": [
            {
                "names": ["traces-apm*","logs-apm*", "metrics-apm*"],
                "privileges": ["auto_configure", "create_doc"]
            }
        ]
    },
    "apm_sourcemap": {
        "index": [
            {
                "names": [".apm-source-map"],
                "privileges": ["read"]
            }
        ]
    },
    "apm_agentcfg": {
        "index": [
            {
                "names": [".apm-agent-configuration"],
                "privileges": ["read"],
                "allow_restricted_indices": true
            }
        ]
    }
}
----
+
NOTE: This example only provides privileges for **writing data**.
See <<apm-feature-roles>> for additional privileges and information.
+
. To set an expiration date for the API key, select **Expire after time**
and input the lifetime of the API key in days.
. Click **Create API key**.
. You _must_ set the API key to be configured to {beats}.
Immediately after the API key is generated and while it is still being displayed, click the
**Encoded** button next to the API key and select **Beats** from the list in the tooltip.
Base64 encoded API keys are not currently supported in this configuration.
+
image::images/apm-api-key-beats.png[API key dropdown highlighting the Beats option]

You can now use this API key in your `apm-server.yml` configuration file:

["source","yml",subs="attributes"]
--------------------
output.elasticsearch:
  api_key: TiNAGG4BaaMdaH1tRfuU:KnR6yE41RrSowb0kQ0HWoA <1>
--------------------
<1> Format is `id:api_key` (as shown in the {beats} dropdown)

[float]
[[apm-beats-api-key-monitor]]
== Create an API key for monitoring

To open **API keys**, find **Stack Management** in the main menu or use the {kibana-ref}/introduction.html#kibana-navigation-search[global search field].
Click **Create API key**.

[role="screenshot"]
image::images/server-api-key-create.png[API key creation]

Enter a name for your API key and select **Restrict privileges**.
In the role descriptors box, assign the appropriate privileges to the new API key.
For example:

[source,json,subs="attributes,callouts"]
----
{
    "apm_monitoring": {
        "index": [
            {
                "names": [".monitoring-beats-*"],
                "privileges": ["create_index", "create_doc"]
            }
      ]
    }
}
----

NOTE: This example only provides privileges for **publishing monitoring data**.
See <<apm-feature-roles>> for additional privileges and information.

To set an expiration date for the API key, select **Expire after time**
and input the lifetime of the API key in days.

Click **Create API key**. In the dropdown, switch to **{beats}** and copy the API key.

You can now use this API key in your +apm-server.yml+ configuration file like this:

["source","yml",subs="attributes"]
--------------------
monitoring.elasticsearch:
  api_key: TiNAGG4BaaMdaH1tRfuU:KnR6yE41RrSowb0kQ0HWoA <1>
--------------------
<1> Format is `id:api_key` (as shown in the {beats} dropdown)

[float]
[[apm-beats-api-key-es]]
== Create an API key with {es} APIs

You can also use {es}'s {ref}/security-api-create-api-key.html[Create API key API] to create a new API key.
For example:

[source,console,subs="attributes,callouts"]
------------------------------------------------------------
POST /_security/api_key
{
  "name": "apm_host001", <1>
  "role_descriptors": {
    "apm_writer": { <2>
      "cluster": ["monitor"],
      "index": [
        {
          "names": ["traces-apm*","logs-apm*", "metrics-apm*"],
          "privileges": ["auto_configure", "create_doc"]
        }
      ]
    },
    "apm_sourcemap": {
      "index": [
        {
          "names": [".apm-source-map"],
          "privileges": ["read"]
        }
      ]
    },
    "apm_agentcfg": {
      "index": [
        {
          "names": [".apm-agent-configuration"],
          "privileges": ["read"],
          "allow_restricted_indices": true
        }
      ]
    }
  }
}
------------------------------------------------------------
<1> Name of the API key
<2> Granted privileges, see <<apm-feature-roles>>

See the {ref}/security-api-create-api-key.html[Create API key] reference for more information.

[float]
[[apm-learn-more-api-keys]]
== Learn more about API keys

See the {es} API key documentation for more information:

* {ref}/security-api-create-api-key.html[Create API key]
* {ref}/security-api-get-api-key.html[Get API key information]
* {ref}/security-api-invalidate-api-key.html[Invalidate API key]
